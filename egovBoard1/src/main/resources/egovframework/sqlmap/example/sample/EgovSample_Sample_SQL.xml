<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Sample">
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="searchVO" type="egovframework.example.sample.service.SampleDefaultVO"/>

	<resultMap id="board" class="egovframework.example.sample.service.BoardVO">
		<result property="idx" column="idx"/>
		<result property="title" column="title"/>
		<result property="writer" column="writer"/>
		<result property="content" column="content"/>
		<result property="regDate" column="reg_date"/>
		<result property="cnt" column="cnt"/>
		<result property="option" column="option"/>
		<result property="setting" column="setting"/>
		<result property="link1" column="link1"/>
		<result property="link2" column="link2"/>
	</resultMap>
	
	<resultMap id="reply" class="egovframework.example.sample.service.ReplyVO">
		<result property="replyIdx" column="reply_idx"/>
		<result property="idx" column="idx"/>
		<result property="writer" column="writer"/>
		<result property="regDate" column="reg_date"/>
	</resultMap>
	
	<resultMap id="login" class="egovframework.example.sample.service.LoginVO">
		<result property="id" column="id" nullValue="no"/>
		<result property="password" column="password" nullValue="no"/>
		<result property="name" column="name" nullValue="no"/>
	</resultMap>
	
	<select id="sampleDAO.getBoardList" resultClass="egovMap">
		<![CDATA[
			SELECT A.*, B.replyCnt
			FROM boardtest A
			LEFT JOIN (SELECT idx, count(*) as replyCnt FROM board_reply GROUP BY idx ORDER BY idx DESC) B
			ON A.idx = B.idx WHERE setting NOT IN ('notice') ORDER BY idx DESC
		]]>
	</select>
	
	<select id="sampleDAO.getNoticeList" resultClass="egovMap">
		<![CDATA[
			SELECT A.*, B.replyCnt
			FROM boardtest A
			LEFT JOIN (SELECT idx, count(*) as replyCnt FROM board_reply GROUP BY idx ORDER BY idx DESC) B
			ON A.idx = B.idx WHERE setting IN ('notice') ORDER BY idx DESC
		]]>
	</select>
	
	<select id="sampleDAO.getFilteredBoardList" resultClass="egovMap">
		<![CDATA[
			SELECT * 
			FROM boardtest 
			WHERE setting IN (#menu#)
			ORDER BY idx DESC
		]]>
	</select>
	
	<select id="sampleDAO.getReplyList" resultClass="egovMap">
		<![CDATA[
			SELECT *
			FROM board_reply 
			WHERE idx=#idx# 
			ORDER BY reg_date ASC
		]]>
	</select>
	
	<select id="sampleDAO.selectBoardByIdx" resultMap="board">
		<![CDATA[
			SELECT *
            FROM boardtest
            WHERE idx=#idx#
		]]>
	</select>
	
	<insert id="sampleDAO.insertBoard">
		<![CDATA[
			INSERT INTO boardtest 
				( writer
				  , title
				  , content
				  , option
				  , setting
				  , link1
				  , link2
				 )
			VALUES ( #writer#
					  , #title#
					  , #content#
					  , #option#
					  , #setting#
					  , #link1#
				  	  , #link2#
					  )
		]]>
	</insert>

	<insert id="sampleDAO.insertReply">
		<![CDATA[
			INSERT INTO board_reply 
				( idx 
				  , writer
				  , reply
				 )
			VALUES ( #idx#
					  , #writer#
					  , #reply#
					  )
		]]>
	</insert>
	
	<select id="sampleDAO.selectBoard" resultMap="board">
        
            SELECT *
            FROM boardtest
            WHERE idx=#idx#
       
    </select>

	<update id="sampleDAO.updateBoard">
		<![CDATA[
			UPDATE boardtest
			SET title=#title#
				, content=#content#
				, setting=#setting#
				, link1=#link1#
				, link2=#link2#
			WHERE idx=#idx#
		]]>
	</update>
	
	<delete id="sampleDAO.deleteBoard">
		DELETE FROM boardtest WHERE idx=#idx#;
		
		ALTER TABLE boardtest AUTO_INCREMENT=1;
		SET @COUNT = 0;
		UPDATE boardtest SET idx = @COUNT:=@COUNT+1;
	</delete>
	
	<delete id="sampleDAO.deleteReply">
		DELETE FROM board_reply 
		WHERE reply_idx=#replyIdx#;
	</delete>
	
	<update id="sampleDAO.updateReply">
		UPDATE board_reply
		SET reply=#reply#
		WHERE reply_idx=#replyIdx#
	</update>
	
	<update id="sampleDAO.updateCount">
		UPDATE boardtest
		SET cnt=#cnt#
		WHERE idx=#idx#
	</update>
	
	<select id="sampleDAO.getName" resultClass="String">
		SELECT IFNULL(MAX(name), 'noName') AS name
		FROM board_user
		WHERE id=#id# AND password=#password#
	</select>
	
	<select id="sampleDAO.getUser" resultMap="login">
		SELECT *
		FROM board_user
		WHERE id=#id# AND name=#name#
	</select>
	<!-- =================================================================================================== -->
	<select id="sampleDAO.selectSampleListTotCnt" parameterClass="searchVO" resultClass="int">

			SELECT COUNT(*) totcnt
			FROM SAMPLE
			WHERE 1=1
			<isEqual prepend="AND" property="searchCondition" compareValue="0">
				ID LIKE '%' || #searchKeyword# || '%'
			</isEqual>
			<isEqual prepend="AND" property="searchCondition" compareValue="1">
				NAME LIKE '%' || #searchKeyword# || '%'
			</isEqual>
	</select>

</sqlMap>
